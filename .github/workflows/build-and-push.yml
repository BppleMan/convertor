name: æ„å»ºå¹¶æ¨é€åˆ° GHCR

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            extra_tag:
                description: "é¢å¤–çš„é•œåƒæ ‡ç­¾ï¼ˆå¦‚ canaryï¼‰"
                type: string
                required: false
            profile:
                description: "æ„å»ºé…ç½®"
                type: choice
                options: [ prod, dev ]
                required: false
                default: prod

permissions:
    contents: read
    packages: write

env:
    DOCKERFILE: ./Dockerfile
    CONTEXT_DIR: .
    TARGET_TRIPLE: x86_64-unknown-linux-musl
    PROFILE: prod
    BIN_NAME: convd

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        steps:
            -   name: æ£€å‡ºä»£ç 
                uses: actions/checkout@v4

            -   name: è§£æé•œåƒåç§°ï¼ˆå°å†™ï¼‰
                id: img
                shell: bash
                run: |
                    NAME="ghcr.io/${{ github.repository }}/convd"
                    echo "image=${NAME,,}" >> "$GITHUB_OUTPUT"

            -   name: å¤„ç†è¾“å…¥å‚æ•°
                id: vars
                shell: bash
                run: |
                    # ç»Ÿä¸€ä½¿ç”¨ dev/prod ä½œä¸ºç¯å¢ƒæ§åˆ¶å‚æ•°
                    p="${{ github.event.inputs.profile }}"
                    if [ -z "$p" ]; then p="${{ env.PROFILE }}"; fi
                    echo "profile=$p" >> "$GITHUB_OUTPUT"
                    
                    # æ˜ å°„åˆ° cargo çš„ç¼–è¯‘é…ç½®
                    if [ "$p" = "prod" ]; then
                        echo "cargo_profile=release" >> "$GITHUB_OUTPUT"
                    else
                        echo "cargo_profile=debug" >> "$GITHUB_OUTPUT"
                    fi
                    
                    e="${{ github.event.inputs.extra_tag }}"
                    echo "extra=$e" >> "$GITHUB_OUTPUT"

            -   name: å®‰è£… Rust å·¥å…·é“¾
                uses: dtolnay/rust-toolchain@stable

            -   name: æ·»åŠ  MUSL ç›®æ ‡å¹³å°
                run: rustup target add x86_64-unknown-linux-musl

            -   name: ç¼“å­˜ Cargo æ„å»ºäº§ç‰©
                uses: actions/cache@v4
                with:
                    path: |
                        ~/.cargo/registry
                        ~/.cargo/git
                        target
                    key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                    restore-keys: |
                        ${{ runner.os }}-cargo-

            -   name: å®‰è£… Zig ç¼–è¯‘å™¨
                uses: mlugg/setup-zig@v2
                with:
                    mirror: 'https://pkg.machengine.org/zig'

            -   name: å®‰è£… cargo-zigbuild
                run: cargo install cargo-zigbuild --locked

            -   name: å®‰è£… Node.js
                uses: actions/setup-node@v5
                with:
                    node-version: '20'

            -   name: å®‰è£… pnpm
                run: npm install -g pnpm

            -   name: æ„å»º MUSL äºŒè¿›åˆ¶æ–‡ä»¶
                shell: bash
                run: |
                    chmod +x ./scripts/build.sh
                    source ./scripts/build.sh && build_musl ${{ steps.vars.outputs.profile }}

            -   name: è·å–ç‰ˆæœ¬å·
                id: version
                shell: bash
                run: |
                    if [[ "${{ github.ref_type }}" == "tag" ]]; then
                        VERSION="${{ github.ref_name }}"
                        VERSION="${VERSION#v}"
                        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
                        echo "source=git-tag" >> "$GITHUB_OUTPUT"
                    else
                        VERSION=$(./target/${{ env.TARGET_TRIPLE }}/${{ steps.vars.outputs.cargo_profile }}/${{ env.BIN_NAME }} tag 2>/dev/null || echo "0.0.0-dev")
                        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
                        echo "source=convd-command" >> "$GITHUB_OUTPUT"
                    fi
                    echo "ğŸ“‹ ç‰ˆæœ¬å·: $VERSION (æ¥æº: $(echo ${{ github.ref_type == 'tag' && 'gitæ ‡ç­¾' || 'convdå‘½ä»¤' }})"

            -   name: ç™»å½•åˆ° GHCR
                uses: docker/login-action@v3
                with:
                    registry: ghcr.io
                    username: ${{ github.actor }}
                    password: ${{ secrets.GITHUB_TOKEN }}

            -   name: ç”Ÿæˆ Docker æ ‡ç­¾
                id: meta
                uses: docker/metadata-action@v5
                with:
                    images: ${{ steps.img.outputs.image }}
                    tags: |
                        type=raw,value=${{ steps.version.outputs.version }}
                        type=raw,value=latest,enable=${{ github.ref_type == 'tag' || (github.event_name == 'workflow_dispatch' && github.event.inputs.extra_tag == 'latest') }}
                        type=sha,format=short,prefix={{branch}}-
                        type=raw,value=${{ steps.vars.outputs.extra }},enable=${{ github.event_name == 'workflow_dispatch' && steps.vars.outputs.extra != '' && steps.vars.outputs.extra != 'latest' }}

            -   name: è®¾ç½® Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: æ„å»ºå¹¶æ¨é€åˆ° GHCR
                uses: docker/build-push-action@v6
                with:
                    context: ${{ env.CONTEXT_DIR }}
                    file: ${{ env.DOCKERFILE }}
                    push: true
                    platforms: linux/amd64
                    tags: ${{ steps.meta.outputs.tags }}
                    build-args: |
                        VERSION=${{ steps.version.outputs.version }}
                        VCS_REF=${{ github.sha }}
                        BUILD_DATE=${{ steps.meta.outputs.created }}
                        TARGET_TRIPLE=${{ env.TARGET_TRIPLE }}
                        PROFILE=${{ steps.vars.outputs.cargo_profile }}
                        BIN_NAME=${{ env.BIN_NAME }}
                        BIN_PATH=target/${{ env.TARGET_TRIPLE }}/${{ steps.vars.outputs.cargo_profile }}/${{ env.BIN_NAME }}
                    cache-from: type=registry,ref=${{ steps.img.outputs.image }}:buildcache
                    cache-to: type=registry,ref=${{ steps.img.outputs.image }}:buildcache,mode=max
