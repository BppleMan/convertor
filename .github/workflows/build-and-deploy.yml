name: æ„å»ºã€æ¨é€å¹¶éƒ¨ç½²

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      profile:
        description: "æ„å»ºé…ç½® (dev/prod)"
        type: choice
        options: [ prod, dev ]
        required: false
        default: prod
      deploy:
        description: "æ˜¯å¦éƒ¨ç½²åˆ° node-vultr-1"
        type: boolean
        required: false
        default: false

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/convd

jobs:
  build-and-push:
    name: æ„å»ºå¤šå¹³å°é•œåƒå¹¶æ¨é€åˆ° GHCR
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.vars.outputs.image }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ„å»º conv å·¥å…·ç”¨äºåç»­æ­¥éª¤
      - name: æ„å»º conv å·¥å…·
        run: cargo install --path crates/conv

      - name: è®¾ç½®æ„å»ºå‚æ•°
        id: vars
        run: |
          PROFILE="${{ github.event.inputs.profile }}"
          if [ -z "$PROFILE" ]; then PROFILE="prod"; fi
          echo "profile=$PROFILE" >> "$GITHUB_OUTPUT"

          # é€šè¿‡ conv è·å– cargo ç¼–è¯‘é…ç½®
          echo "cargo_profile=$(conv var cargo-profile $PROFILE)" >> "$GITHUB_OUTPUT"

          # é•œåƒåç§°ï¼ˆå°å†™ï¼‰
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "image=${IMAGE,,}" >> "$GITHUB_OUTPUT"

      - name: æ·»åŠ  MUSL ç›®æ ‡å¹³å°
        run: rustup target add x86_64-unknown-linux-musl aarch64-unknown-linux-musl

      - name: å®‰è£… Zig ç¼–è¯‘å™¨
        uses: mlugg/setup-zig@v2

      - name: å®‰è£… cargo-zigbuild
        run: cargo install cargo-zigbuild --locked

      - name: ç¼“å­˜ Cargo æ„å»ºäº§ç‰©
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: å®‰è£… pnpm
        run: npm install -g pnpm

      - name: ç¼“å­˜ pnpm ä¾èµ–
        uses: actions/cache@v4
        with:
          path: dashboard/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('dashboard/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: å®‰è£… Dashboard ä¾èµ–
        run: pnpm install
        working-directory: dashboard

      - name: ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ£€æŸ¥åŸºç¡€é•œåƒå¯è®¿é—®æ€§
        run: |
          echo "ğŸ” æ£€æŸ¥åŸºç¡€é•œåƒ: ghcr.io/convertor-gitops/convertor/base:alpine3.20"
          echo "ğŸ‘¤ å½“å‰ç™»å½•ç”¨æˆ·: ${{ github.actor }}"
          echo "ğŸ“¦ ä»“åº“æ‰€æœ‰è€…: ${{ github.repository_owner }}"

          # å°è¯• inspect é•œåƒ
          if docker buildx imagetools inspect ghcr.io/convertor-gitops/convertor/base:alpine3.20 > /dev/null 2>&1; then
            echo "âœ… åŸºç¡€é•œåƒå¯è®¿é—®"
          else
            echo "âŒ åŸºç¡€é•œåƒä¸å¯è®¿é—®ï¼Œå°è¯•æ‹‰å–..."
            if docker pull ghcr.io/convertor-gitops/convertor/base:alpine3.20; then
              echo "âœ… åŸºç¡€é•œåƒæ‹‰å–æˆåŠŸ"
            else
              echo "âŒ åŸºç¡€é•œåƒæ‹‰å–å¤±è´¥"
              exit 1
            fi
          fi

      - name: ä½¿ç”¨ conv æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆå¤šæ¶æ„ï¼‰
        run: |
          # conv image ä¼šè‡ªåŠ¨ï¼š
          # 1. æ„å»ºäºŒè¿›åˆ¶ã€Dashboard å’Œ Docker é•œåƒï¼ˆå¤šæ¶æ„ï¼‰
          # 2. æ¨é€åˆ°æŒ‡å®šçš„ registries
          # 3. åˆ›å»ºå¤šæ¶æ„ manifestï¼ˆç‰ˆæœ¬å· + latest æ ‡ç­¾ï¼‰
          conv image ${{ steps.vars.outputs.profile }} \
            --arch amd,arm \
            --dashboard \
            --user ${{ github.repository_owner }} \
            --registries ghcr

  deploy:
    name: éƒ¨ç½²åˆ° node-vultr-1
    needs: build-and-push
    runs-on: ubuntu-latest
    # ä»…åœ¨ä»¥ä¸‹æƒ…å†µéƒ¨ç½²ï¼š
    # 1. æ¨é€ tag æ—¶
    # 2. æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº†éƒ¨ç½²
    if: github.ref_type == 'tag' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CONVERTOR_SSH_KEY }}" > ~/.ssh/convertor_ed25519
          chmod 600 ~/.ssh/convertor_ed25519
          ssh-keyscan -H 167.179.111.233 >> ~/.ssh/known_hosts

      - name: é…ç½® SSH config
        run: |
          cat >> ~/.ssh/config <<EOF
          Host node-vultr-1
            HostName 167.179.111.233
            Port 22
            User root
            IdentityFile ~/.ssh/convertor_ed25519
            StrictHostKeyChecking no
            HostKeyAlgorithms ssh-ed25519
          EOF
          chmod 600 ~/.ssh/config

      - name: å®‰è£… Docker è¿è¡Œæ—¶ï¼ˆå¦‚éœ€è¦ï¼‰
        run: |
          ssh node-vultr-1 << 'EOF'
          # æ£€æŸ¥ Docker æ˜¯å¦å·²å®‰è£…
          if ! command -v docker &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl enable docker
            systemctl start docker
            rm get-docker.sh
            echo "âœ… Docker å®‰è£…å®Œæˆ"
          else
            echo "âœ… Docker å·²å®‰è£…: $(docker --version)"
          fi
          EOF

      - name: ä¸Šä¼  compose.yaml å¹¶éƒ¨ç½²
        run: |
          # ä¸Šä¼  compose.yaml
          scp compose/compose.yaml node-vultr-1:/tmp/compose.yaml

          # æ‰§è¡Œéƒ¨ç½²
          ssh node-vultr-1 << 'EOF'
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p /opt/convertor

          # æ›´æ–° compose.yaml
          mv /tmp/compose.yaml /opt/convertor/compose.yaml

          cd /opt/convertor

          # æ‹‰å–æœ€æ–°é•œåƒï¼ˆlatest æ ‡ç­¾ï¼‰
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
          docker compose pull convd

          # å¯åŠ¨æˆ–é‡å¯ convd æœåŠ¡
          echo "ğŸ”„ é‡å¯ convd æœåŠ¡..."
          docker compose up -d convd

          # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
          docker image prune -f

          echo "âœ… convd æœåŠ¡å·²æ›´æ–°"
          echo ""
          echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
          docker compose ps
          EOF
