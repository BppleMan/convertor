name: éƒ¨ç½²åˆ° node-vultr-1

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      deploy:
        description: "æ˜¯å¦éƒ¨ç½²åˆ° node-vultr-1"
        type: boolean
        required: false
        default: true

permissions:
  contents: read

env:
  DEPLOY_HOST: node-vultr-1
  DEPLOY_HOSTNAME: 167.179.111.233

jobs:
  deploy:
    name: éƒ¨ç½²åˆ° node-vultr-1
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CONVERTOR_SSH_KEY }}" > ~/.ssh/convertor_ed25519
          chmod 600 ~/.ssh/convertor_ed25519
          ssh-keyscan -H ${{ env.DEPLOY_HOSTNAME }} >> ~/.ssh/known_hosts

      - name: é…ç½® SSH config
        run: |
          cat >> ~/.ssh/config <<EOF
          Host ${{ env.DEPLOY_HOST }}
            HostName ${{ env.DEPLOY_HOSTNAME }}
            Port 22
            User root
            IdentityFile ~/.ssh/convertor_ed25519
            StrictHostKeyChecking no
            HostKeyAlgorithms ssh-ed25519
          EOF
          chmod 600 ~/.ssh/config

      - name: å®‰è£… Docker è¿è¡Œæ—¶ï¼ˆå¦‚éœ€è¦ï¼‰
        run: |
          ssh ${{ env.DEPLOY_HOST }} << 'EOF'
          # æ£€æŸ¥ Docker æ˜¯å¦å·²å®‰è£…
          if ! command -v docker &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl enable docker
            systemctl start docker
            rm get-docker.sh
            echo "âœ… Docker å®‰è£…å®Œæˆ"
          else
            echo "âœ… Docker å·²å®‰è£…: $(docker --version)"
          fi
          EOF

      - name: ä¸Šä¼  compose.yaml å¹¶éƒ¨ç½²
        run: |
          # ä¸Šä¼  compose.yaml
          scp compose/compose.yaml ${{ env.DEPLOY_HOST }}:/tmp/compose.yaml

          # æ‰§è¡Œéƒ¨ç½²
          ssh ${{ env.DEPLOY_HOST }} << 'EOF'
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p /opt/convertor

          # æ›´æ–° compose.yaml
          mv /tmp/compose.yaml /opt/convertor/compose.yaml

          cd /opt/convertor

          # æ‹‰å–æœ€æ–°é•œåƒï¼ˆlatest æ ‡ç­¾ï¼‰
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
          docker compose pull convd

          # å¯åŠ¨æˆ–é‡å¯ convd æœåŠ¡
          echo "ğŸ”„ é‡å¯ convd æœåŠ¡..."
          docker compose up -d convd

          # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
          docker image prune -f

          echo "âœ… convd æœåŠ¡å·²æ›´æ–°"
          echo ""
          echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
          docker compose ps
          EOF
