name: æ„å»ºå¹¶æ¨é€

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      profile:
        description: "æ„å»ºé…ç½® (dev/prod)"
        type: choice
        options: [ prod, dev ]
        required: false
        default: prod

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    name: æ„å»ºå¤šå¹³å°é•œåƒå¹¶æ¨é€åˆ° GHCR
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ„å»º conv å·¥å…·ç”¨äºåç»­æ­¥éª¤
      - name: æ„å»º conv å·¥å…·
        run: cargo install --path crates/conv

      - name: è®¾ç½®æ„å»ºå‚æ•°
        id: vars
        run: |
          PROFILE="${{ github.event.inputs.profile }}"
          if [ -z "$PROFILE" ]; then PROFILE="prod"; fi
          echo "profile=$PROFILE" >> "$GITHUB_OUTPUT"

      - name: æ·»åŠ  MUSL ç›®æ ‡å¹³å°
        run: rustup target add x86_64-unknown-linux-musl aarch64-unknown-linux-musl

      - name: å®‰è£… Zig ç¼–è¯‘å™¨
        uses: mlugg/setup-zig@v2

      - name: å®‰è£… cargo-zigbuild
        run: cargo install cargo-zigbuild --locked

      - name: ç¼“å­˜ Cargo æ„å»ºäº§ç‰©
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: å®‰è£… pnpm
        run: npm install -g pnpm

      - name: ç¼“å­˜ pnpm ä¾èµ–
        uses: actions/cache@v4
        with:
          path: dashboard/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('dashboard/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: å®‰è£… Dashboard ä¾èµ–
        run: pnpm install
        working-directory: dashboard

      - name: ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ£€æŸ¥åŸºç¡€é•œåƒå¯è®¿é—®æ€§
        run: |
          set -e
          # ä½¿ç”¨ conv ç”Ÿæˆ base é•œåƒæ ‡ç­¾ï¼ˆlatestï¼‰ï¼Œç”¨äºåç»­æ£€æŸ¥
          BASE_IMAGE=$(conv image prod --name base -r ghcr.io --user convertor-gitops -v latest -t)

          echo "ğŸ” æ£€æŸ¥åŸºç¡€é•œåƒ: $BASE_IMAGE"
          echo "ğŸ‘¤ å½“å‰ç™»å½•ç”¨æˆ·: ${{ github.actor }}"
          echo "ğŸ“¦ ä»“åº“æ‰€æœ‰è€…: ${{ github.repository_owner }}"

          # å°è¯• inspect é•œåƒ
          if docker buildx imagetools inspect "$BASE_IMAGE" > /dev/null 2>&1; then
            echo "âœ… åŸºç¡€é•œåƒå¯è®¿é—®"
          else
            echo "âŒ åŸºç¡€é•œåƒä¸å¯è®¿é—®ï¼Œå°è¯•æ‹‰å–..."
            if docker pull "$BASE_IMAGE"; then
              echo "âœ… åŸºç¡€é•œåƒæ‹‰å–æˆåŠŸ"
            else
              echo "âŒ åŸºç¡€é•œåƒæ‹‰å–å¤±è´¥"
              exit 1
            fi
          fi

      - name: ä½¿ç”¨ conv æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆå¤šæ¶æ„ï¼‰
        run: |
          # conv image ä¼šè‡ªåŠ¨ï¼š
          # 1. æ„å»ºäºŒè¿›åˆ¶ã€Dashboard å’Œ Docker é•œåƒï¼ˆå¤šæ¶æ„ï¼‰
          # 2. æ¨é€åˆ°æŒ‡å®šçš„ registries
          # 3. åˆ›å»ºå¤šæ¶æ„ manifestï¼ˆç‰ˆæœ¬å· + latest æ ‡ç­¾ï¼‰
          conv image ${{ steps.vars.outputs.profile }} \
            --name convd \
            --arch amd,arm \
            --dashboard \
            --user ${{ github.repository_owner }} \
            --registries ghcr
